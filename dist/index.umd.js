(function(n,o){typeof exports=="object"&&typeof module!="undefined"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(n=typeof globalThis!="undefined"?globalThis:n||self,o(n.MemoIframeIpc={}))})(this,function(n){"use strict";var p=Object.defineProperty;var g=(n,o,l)=>o in n?p(n,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[o]=l;var c=(n,o,l)=>g(n,typeof o!="symbol"?o+"":o,l);var h=(n,o,l)=>new Promise((e,s)=>{var r=i=>{try{a(l.next(i))}catch(d){s(d)}},t=i=>{try{a(l.throw(i))}catch(d){s(d)}},a=i=>i.done?e(i.value):Promise.resolve(i.value).then(r,t);a((l=l.apply(n,o)).next())});class o{constructor(e){c(this,"windowMessageHandler",{});c(this,"messageHandler",{});c(this,"callbackId",1);c(this,"callbacks",{});c(this,"isIframe",!0);c(this,"source",{url:"",query:{}});c(this,"defaultOptions",{methods:["localStorage.removeItem","localStorage.setItem","localStorage.getItem","localStorage.clear","memoryStorage.removeItem","memoryStorage.setItem","memoryStorage.getItem","memoryStorage.clear","storage.removeItem","storage.setItem","storage.getItem","storage.clear","storage.keys","player.play","player.pause","player.seek","player.seekForward","player.seekBackward","player.getCurrentTime","player.screenshot","browser.windowPostMessage","browser.openChildWindow"],appId:"memo-app"});c(this,"withAppIdKeys",["storage.removeItem","storage.setItem","storage.getItem","storage.clear","storage.keys","file.savePluginFile","file.readPluginFile","file.checkPluginFileExist"]);c(this,"options");this.options={methods:[...this.defaultOptions.methods,...e.methods||[]],appId:e.appId||this.defaultOptions.appId},this.init()}init(){this.source.url=window.location.href,this.source.query=this.getQueryParams(this.source.url),window.addEventListener("message",e=>{const{from:s,action:r,params:t}=e.data;if(s===`main:${this.options.appId}`){if(r==="IPC_RESPONSE_SEND")for(const a in this.windowMessageHandler)this.windowMessageHandler[a](t.event,t.data);if(r==="IPC_RESPONSE"){const{callbackId:a,success:i,params:d}=e.data;this.callbacks[a]&&(i?this.callbacks[a].success(d.data):this.callbacks[a].error(d.error),delete this.callbacks[a])}if(r==="IPC_RESPONSE_SEND_MESSAGE")for(const a in this.messageHandler)this.messageHandler[a](t.event,t.data)}}),this.addMethods(this.options.methods)}getQueryParams(e){const s={},r=e.match(/\?([^#]+)/);if(r){const a=r[1],i=new URLSearchParams(a);for(const[d,m]of i.entries())s[d]=m}const t=e.match(/#.*\?(.+)/);if(t){const a=t[1],i=new URLSearchParams(a);for(const[d,m]of i.entries())s[d]=m}return s}addMethod(e){const s=e.split(".");let r=this;for(let t=0;t<s.length-1;t++)r[s[t]]||(r[s[t]]={}),r=r[s[t]];r[s[s.length-1]]=(...t)=>(this.withAppIdKeys.includes(e)&&t.push(this.options.appId),new Promise((a,i)=>{this.callMain(e,t,a,i)}))}addMethods(e){for(const s of e)this.addMethod(s)}callMain(e,s,r,t){this.callbackId++,this.callbacks[this.callbackId]={success:r,error:t},window.parent.postMessage({from:`renderer:${this.options.appId}`,action:"IPC_REQUEST",data:{callbackId:this.callbackId,method:e,params:s}},"*")}handleMessage(e,s){return h(this,null,function*(){this.messageHandler[s]=e})}removeHandler(e){return h(this,null,function*(){e&&this.messageHandler[e]&&delete this.messageHandler[e]})}handleWindowMessage(e,s){return h(this,null,function*(){this.windowMessageHandler[s]=e})}removeWindowHandler(e){return h(this,null,function*(){e&&this.windowMessageHandler[e]&&delete this.windowMessageHandler[e]})}}n.Bridge=o,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
